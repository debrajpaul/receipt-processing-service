{
 "Resources": {
  "OpsAlertsTopicF77DA89B": {
   "Type": "AWS::SNS::Topic",
   "Properties": {
    "DisplayName": "Operations Alerts",
    "TopicName": "ops-alerts"
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/OpsAlertsTopic/Resource"
   }
  },
  "OpsAlertsTopicpauldebraj7gmailcomD9AF7B3E": {
   "Type": "AWS::SNS::Subscription",
   "Properties": {
    "Endpoint": "pauldebraj7@gmail.com",
    "Protocol": "email",
    "TopicArn": {
     "Ref": "OpsAlertsTopicF77DA89B"
    }
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/OpsAlertsTopic/pauldebraj7@gmail.com/Resource"
   }
  },
  "OpsAlertsTopicPolicyDD649D9F": {
   "Type": "AWS::SNS::TopicPolicy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "sns:Publish",
       "Effect": "Allow",
       "Principal": {
        "Service": "budgets.amazonaws.com"
       },
       "Resource": {
        "Ref": "OpsAlertsTopicF77DA89B"
       },
       "Sid": "0"
      }
     ],
     "Version": "2012-10-17"
    },
    "Topics": [
     {
      "Ref": "OpsAlertsTopicF77DA89B"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/OpsAlertsTopicPolicy/Resource"
   }
  },
  "AutomatedReceiptsBucketF072455A": {
   "Type": "AWS::S3::Bucket",
   "Properties": {
    "BucketEncryption": {
     "ServerSideEncryptionConfiguration": [
      {
       "ServerSideEncryptionByDefault": {
        "SSEAlgorithm": "AES256"
       }
      }
     ]
    },
    "BucketName": "automated-receipts-333208197562",
    "PublicAccessBlockConfiguration": {
     "BlockPublicAcls": true,
     "BlockPublicPolicy": true,
     "IgnorePublicAcls": true,
     "RestrictPublicBuckets": true
    }
   },
   "UpdateReplacePolicy": "Retain",
   "DeletionPolicy": "Retain",
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/AutomatedReceiptsBucket/Resource"
   }
  },
  "AutomatedReceiptsBucketPolicy5109FB14": {
   "Type": "AWS::S3::BucketPolicy",
   "Properties": {
    "Bucket": {
     "Ref": "AutomatedReceiptsBucketF072455A"
    },
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "s3:*",
       "Condition": {
        "Bool": {
         "aws:SecureTransport": "false"
        }
       },
       "Effect": "Deny",
       "Principal": {
        "AWS": "*"
       },
       "Resource": [
        {
         "Fn::GetAtt": [
          "AutomatedReceiptsBucketF072455A",
          "Arn"
         ]
        },
        {
         "Fn::Join": [
          "",
          [
           {
            "Fn::GetAtt": [
             "AutomatedReceiptsBucketF072455A",
             "Arn"
            ]
           },
           "/*"
          ]
         ]
        }
       ]
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/AutomatedReceiptsBucket/Policy/Resource"
   }
  },
  "AutomatedReceiptsBucketNotifications1E91C557": {
   "Type": "Custom::S3BucketNotifications",
   "Properties": {
    "ServiceToken": {
     "Fn::GetAtt": [
      "BucketNotificationsHandler050a0587b7544547bf325f094a3db8347ECC3691",
      "Arn"
     ]
    },
    "BucketName": {
     "Ref": "AutomatedReceiptsBucketF072455A"
    },
    "NotificationConfiguration": {
     "QueueConfigurations": [
      {
       "Events": [
        "s3:ObjectCreated:*"
       ],
       "Filter": {
        "Key": {
         "FilterRules": [
          {
           "Name": "prefix",
           "Value": "incoming/"
          }
         ]
        }
       },
       "QueueArn": {
        "Fn::GetAtt": [
         "ReceiptsQueue30E2F02B",
         "Arn"
        ]
       }
      }
     ]
    },
    "Managed": true,
    "SkipDestinationValidation": false
   },
   "DependsOn": [
    "AutomatedReceiptsBucketPolicy5109FB14",
    "ReceiptsQueuePolicyBD8BC66D",
    "ReceiptsQueue30E2F02B"
   ],
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/AutomatedReceiptsBucket/Notifications/Resource"
   }
  },
  "ReceiptsDlq731F2BBC": {
   "Type": "AWS::SQS::Queue",
   "Properties": {
    "MessageRetentionPeriod": 1209600,
    "QueueName": "receipts-dlq"
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/ReceiptsDlq/Resource"
   }
  },
  "ReceiptsQueue30E2F02B": {
   "Type": "AWS::SQS::Queue",
   "Properties": {
    "QueueName": "receipts-queue",
    "RedrivePolicy": {
     "deadLetterTargetArn": {
      "Fn::GetAtt": [
       "ReceiptsDlq731F2BBC",
       "Arn"
      ]
     },
     "maxReceiveCount": 3
    },
    "SqsManagedSseEnabled": true,
    "VisibilityTimeout": 300
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/ReceiptsQueue/Resource"
   }
  },
  "ReceiptsQueuePolicyBD8BC66D": {
   "Type": "AWS::SQS::QueuePolicy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "sqs:SendMessage",
       "Condition": {
        "ArnEquals": {
         "aws:SourceArn": {
          "Fn::GetAtt": [
           "AutomatedReceiptsBucketF072455A",
           "Arn"
          ]
         }
        },
        "StringEquals": {
         "aws:SourceAccount": "333208197562"
        }
       },
       "Effect": "Allow",
       "Principal": {
        "Service": "s3.amazonaws.com"
       },
       "Resource": {
        "Fn::GetAtt": [
         "ReceiptsQueue30E2F02B",
         "Arn"
        ]
       },
       "Sid": "AllowOnlyReceiptsBucketToSend"
      },
      {
       "Action": [
        "sqs:SendMessage",
        "sqs:GetQueueAttributes",
        "sqs:GetQueueUrl"
       ],
       "Condition": {
        "ArnLike": {
         "aws:SourceArn": {
          "Fn::GetAtt": [
           "AutomatedReceiptsBucketF072455A",
           "Arn"
          ]
         }
        }
       },
       "Effect": "Allow",
       "Principal": {
        "Service": "s3.amazonaws.com"
       },
       "Resource": {
        "Fn::GetAtt": [
         "ReceiptsQueue30E2F02B",
         "Arn"
        ]
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "Queues": [
     {
      "Ref": "ReceiptsQueue30E2F02B"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/ReceiptsQueue/Policy/Resource"
   }
  },
  "ReceiptsTable036B344A": {
   "Type": "AWS::DynamoDB::Table",
   "Properties": {
    "AttributeDefinitions": [
     {
      "AttributeName": "receipt_id",
      "AttributeType": "S"
     },
     {
      "AttributeName": "date",
      "AttributeType": "S"
     }
    ],
    "BillingMode": "PAY_PER_REQUEST",
    "KeySchema": [
     {
      "AttributeName": "receipt_id",
      "KeyType": "HASH"
     },
     {
      "AttributeName": "date",
      "KeyType": "RANGE"
     }
    ],
    "TableName": "Receipts"
   },
   "UpdateReplacePolicy": "Retain",
   "DeletionPolicy": "Retain",
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/ReceiptsTable/Resource"
   }
  },
  "WorkerVpcA12AC6F9": {
   "Type": "AWS::EC2::VPC",
   "Properties": {
    "CidrBlock": "10.0.0.0/16",
    "EnableDnsHostnames": true,
    "EnableDnsSupport": true,
    "InstanceTenancy": "default",
    "Tags": [
     {
      "Key": "Name",
      "Value": "InfraCdkStack/WorkerVpc"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerVpc/Resource"
   }
  },
  "WorkerVpcPublicSubnet1Subnet549B8620": {
   "Type": "AWS::EC2::Subnet",
   "Properties": {
    "AvailabilityZone": "ap-south-1a",
    "CidrBlock": "10.0.0.0/17",
    "MapPublicIpOnLaunch": true,
    "Tags": [
     {
      "Key": "aws-cdk:subnet-name",
      "Value": "Public"
     },
     {
      "Key": "aws-cdk:subnet-type",
      "Value": "Public"
     },
     {
      "Key": "Name",
      "Value": "InfraCdkStack/WorkerVpc/PublicSubnet1"
     }
    ],
    "VpcId": {
     "Ref": "WorkerVpcA12AC6F9"
    }
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerVpc/PublicSubnet1/Subnet"
   }
  },
  "WorkerVpcPublicSubnet1RouteTable64D1002B": {
   "Type": "AWS::EC2::RouteTable",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "InfraCdkStack/WorkerVpc/PublicSubnet1"
     }
    ],
    "VpcId": {
     "Ref": "WorkerVpcA12AC6F9"
    }
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerVpc/PublicSubnet1/RouteTable"
   }
  },
  "WorkerVpcPublicSubnet1RouteTableAssociation1C13947A": {
   "Type": "AWS::EC2::SubnetRouteTableAssociation",
   "Properties": {
    "RouteTableId": {
     "Ref": "WorkerVpcPublicSubnet1RouteTable64D1002B"
    },
    "SubnetId": {
     "Ref": "WorkerVpcPublicSubnet1Subnet549B8620"
    }
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerVpc/PublicSubnet1/RouteTableAssociation"
   }
  },
  "WorkerVpcPublicSubnet1DefaultRoute52FDC25E": {
   "Type": "AWS::EC2::Route",
   "Properties": {
    "DestinationCidrBlock": "0.0.0.0/0",
    "GatewayId": {
     "Ref": "WorkerVpcIGWC2B94A1A"
    },
    "RouteTableId": {
     "Ref": "WorkerVpcPublicSubnet1RouteTable64D1002B"
    }
   },
   "DependsOn": [
    "WorkerVpcVPCGWDDC7E69B"
   ],
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerVpc/PublicSubnet1/DefaultRoute"
   }
  },
  "WorkerVpcPublicSubnet2Subnet4C3F610E": {
   "Type": "AWS::EC2::Subnet",
   "Properties": {
    "AvailabilityZone": "ap-south-1b",
    "CidrBlock": "10.0.128.0/17",
    "MapPublicIpOnLaunch": true,
    "Tags": [
     {
      "Key": "aws-cdk:subnet-name",
      "Value": "Public"
     },
     {
      "Key": "aws-cdk:subnet-type",
      "Value": "Public"
     },
     {
      "Key": "Name",
      "Value": "InfraCdkStack/WorkerVpc/PublicSubnet2"
     }
    ],
    "VpcId": {
     "Ref": "WorkerVpcA12AC6F9"
    }
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerVpc/PublicSubnet2/Subnet"
   }
  },
  "WorkerVpcPublicSubnet2RouteTableAB97C578": {
   "Type": "AWS::EC2::RouteTable",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "InfraCdkStack/WorkerVpc/PublicSubnet2"
     }
    ],
    "VpcId": {
     "Ref": "WorkerVpcA12AC6F9"
    }
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerVpc/PublicSubnet2/RouteTable"
   }
  },
  "WorkerVpcPublicSubnet2RouteTableAssociation7CE29543": {
   "Type": "AWS::EC2::SubnetRouteTableAssociation",
   "Properties": {
    "RouteTableId": {
     "Ref": "WorkerVpcPublicSubnet2RouteTableAB97C578"
    },
    "SubnetId": {
     "Ref": "WorkerVpcPublicSubnet2Subnet4C3F610E"
    }
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerVpc/PublicSubnet2/RouteTableAssociation"
   }
  },
  "WorkerVpcPublicSubnet2DefaultRoute7351E087": {
   "Type": "AWS::EC2::Route",
   "Properties": {
    "DestinationCidrBlock": "0.0.0.0/0",
    "GatewayId": {
     "Ref": "WorkerVpcIGWC2B94A1A"
    },
    "RouteTableId": {
     "Ref": "WorkerVpcPublicSubnet2RouteTableAB97C578"
    }
   },
   "DependsOn": [
    "WorkerVpcVPCGWDDC7E69B"
   ],
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerVpc/PublicSubnet2/DefaultRoute"
   }
  },
  "WorkerVpcIGWC2B94A1A": {
   "Type": "AWS::EC2::InternetGateway",
   "Properties": {
    "Tags": [
     {
      "Key": "Name",
      "Value": "InfraCdkStack/WorkerVpc"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerVpc/IGW"
   }
  },
  "WorkerVpcVPCGWDDC7E69B": {
   "Type": "AWS::EC2::VPCGatewayAttachment",
   "Properties": {
    "InternetGatewayId": {
     "Ref": "WorkerVpcIGWC2B94A1A"
    },
    "VpcId": {
     "Ref": "WorkerVpcA12AC6F9"
    }
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerVpc/VPCGW"
   }
  },
  "WorkerSecurityGroup5529CF0B": {
   "Type": "AWS::EC2::SecurityGroup",
   "Properties": {
    "GroupDescription": "Security group for the receipt worker service",
    "SecurityGroupEgress": [
     {
      "CidrIp": "0.0.0.0/0",
      "Description": "Allow all outbound traffic by default",
      "IpProtocol": "-1"
     }
    ],
    "VpcId": {
     "Ref": "WorkerVpcA12AC6F9"
    }
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerSecurityGroup/Resource"
   }
  },
  "WorkerClusterB2BB5BD9": {
   "Type": "AWS::ECS::Cluster",
   "Properties": {
    "ClusterName": "receipt-worker-cluster"
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerCluster/Resource"
   }
  },
  "WorkerLogGroup31FDBE4A": {
   "Type": "AWS::Logs::LogGroup",
   "Properties": {
    "LogGroupName": "/aws/ecs/receipt-worker",
    "RetentionInDays": 30
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerLogGroup/Resource"
   }
  },
  "WorkerTaskDefinitionTaskRoleA8028804": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "ecs-tasks.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerTaskDefinition/TaskRole/Resource"
   }
  },
  "WorkerTaskDefinitionTaskRoleDefaultPolicyEAEEDD06": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "sqs:ReceiveMessage",
        "sqs:ChangeMessageVisibility",
        "sqs:GetQueueUrl",
        "sqs:DeleteMessage",
        "sqs:GetQueueAttributes"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "ReceiptsQueue30E2F02B",
         "Arn"
        ]
       }
      },
      {
       "Action": [
        "s3:GetObject*",
        "s3:GetBucket*",
        "s3:List*",
        "s3:DeleteObject*",
        "s3:PutObject",
        "s3:PutObjectLegalHold",
        "s3:PutObjectRetention",
        "s3:PutObjectTagging",
        "s3:PutObjectVersionTagging",
        "s3:Abort*"
       ],
       "Effect": "Allow",
       "Resource": [
        {
         "Fn::GetAtt": [
          "AutomatedReceiptsBucketF072455A",
          "Arn"
         ]
        },
        {
         "Fn::Join": [
          "",
          [
           {
            "Fn::GetAtt": [
             "AutomatedReceiptsBucketF072455A",
             "Arn"
            ]
           },
           "/*"
          ]
         ]
        }
       ]
      },
      {
       "Action": [
        "dynamodb:BatchGetItem",
        "dynamodb:GetRecords",
        "dynamodb:GetShardIterator",
        "dynamodb:Query",
        "dynamodb:GetItem",
        "dynamodb:Scan",
        "dynamodb:ConditionCheckItem",
        "dynamodb:BatchWriteItem",
        "dynamodb:PutItem",
        "dynamodb:UpdateItem",
        "dynamodb:DeleteItem",
        "dynamodb:DescribeTable"
       ],
       "Effect": "Allow",
       "Resource": [
        {
         "Fn::GetAtt": [
          "ReceiptsTable036B344A",
          "Arn"
         ]
        },
        {
         "Ref": "AWS::NoValue"
        }
       ]
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "WorkerTaskDefinitionTaskRoleDefaultPolicyEAEEDD06",
    "Roles": [
     {
      "Ref": "WorkerTaskDefinitionTaskRoleA8028804"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerTaskDefinition/TaskRole/DefaultPolicy/Resource"
   }
  },
  "WorkerTaskDefinition8AD2CCFF": {
   "Type": "AWS::ECS::TaskDefinition",
   "Properties": {
    "ContainerDefinitions": [
     {
      "Environment": [
       {
        "Name": "RECEIPTS_QUEUE_URL",
        "Value": {
         "Ref": "ReceiptsQueue30E2F02B"
        }
       },
       {
        "Name": "RECEIPTS_TABLE_NAME",
        "Value": {
         "Ref": "ReceiptsTable036B344A"
        }
       },
       {
        "Name": "RECEIPTS_BUCKET_NAME",
        "Value": {
         "Ref": "AutomatedReceiptsBucketF072455A"
        }
       }
      ],
      "Essential": true,
      "Image": "public.ecr.aws/docker/library/node:18-alpine",
      "LogConfiguration": {
       "LogDriver": "awslogs",
       "Options": {
        "awslogs-group": {
         "Ref": "WorkerLogGroup31FDBE4A"
        },
        "awslogs-stream-prefix": "worker",
        "awslogs-region": "ap-south-1"
       }
      },
      "Name": "receipt-worker",
      "PortMappings": [
       {
        "ContainerPort": 8080,
        "Protocol": "tcp"
       }
      ]
     }
    ],
    "Cpu": "512",
    "ExecutionRoleArn": {
     "Fn::GetAtt": [
      "WorkerTaskDefinitionExecutionRole8F38446C",
      "Arn"
     ]
    },
    "Family": "InfraCdkStackWorkerTaskDefinition794769B3",
    "Memory": "1024",
    "NetworkMode": "awsvpc",
    "RequiresCompatibilities": [
     "FARGATE"
    ],
    "TaskRoleArn": {
     "Fn::GetAtt": [
      "WorkerTaskDefinitionTaskRoleA8028804",
      "Arn"
     ]
    }
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerTaskDefinition/Resource"
   }
  },
  "WorkerTaskDefinitionExecutionRole8F38446C": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "ecs-tasks.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    }
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerTaskDefinition/ExecutionRole/Resource"
   }
  },
  "WorkerTaskDefinitionExecutionRoleDefaultPolicy849552D7": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": [
        "logs:CreateLogStream",
        "logs:PutLogEvents"
       ],
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "WorkerLogGroup31FDBE4A",
         "Arn"
        ]
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "WorkerTaskDefinitionExecutionRoleDefaultPolicy849552D7",
    "Roles": [
     {
      "Ref": "WorkerTaskDefinitionExecutionRole8F38446C"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerTaskDefinition/ExecutionRole/DefaultPolicy/Resource"
   }
  },
  "WorkerService99815FA9": {
   "Type": "AWS::ECS::Service",
   "Properties": {
    "Cluster": {
     "Ref": "WorkerClusterB2BB5BD9"
    },
    "DeploymentConfiguration": {
     "Alarms": {
      "AlarmNames": [],
      "Enable": false,
      "Rollback": false
     },
     "MaximumPercent": 200,
     "MinimumHealthyPercent": 50
    },
    "DesiredCount": 1,
    "EnableECSManagedTags": false,
    "LaunchType": "FARGATE",
    "NetworkConfiguration": {
     "AwsvpcConfiguration": {
      "AssignPublicIp": "ENABLED",
      "SecurityGroups": [
       {
        "Fn::GetAtt": [
         "WorkerSecurityGroup5529CF0B",
         "GroupId"
        ]
       }
      ],
      "Subnets": [
       {
        "Ref": "WorkerVpcPublicSubnet1Subnet549B8620"
       },
       {
        "Ref": "WorkerVpcPublicSubnet2Subnet4C3F610E"
       }
      ]
     }
    },
    "ServiceName": "receipt-worker-service",
    "TaskDefinition": {
     "Ref": "WorkerTaskDefinition8AD2CCFF"
    }
   },
   "DependsOn": [
    "WorkerTaskDefinitionTaskRoleDefaultPolicyEAEEDD06",
    "WorkerTaskDefinitionTaskRoleA8028804"
   ],
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerService/Service"
   }
  },
  "WorkerServiceTaskCountTarget94398C8F": {
   "Type": "AWS::ApplicationAutoScaling::ScalableTarget",
   "Properties": {
    "MaxCapacity": 10,
    "MinCapacity": 1,
    "ResourceId": {
     "Fn::Join": [
      "",
      [
       "service/",
       {
        "Ref": "WorkerClusterB2BB5BD9"
       },
       "/",
       {
        "Fn::GetAtt": [
         "WorkerService99815FA9",
         "Name"
        ]
       }
      ]
     ]
    },
    "RoleARN": {
     "Fn::Join": [
      "",
      [
       "arn:",
       {
        "Ref": "AWS::Partition"
       },
       ":iam::333208197562:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
      ]
     ]
    },
    "ScalableDimension": "ecs:service:DesiredCount",
    "ServiceNamespace": "ecs"
   },
   "DependsOn": [
    "WorkerTaskDefinitionTaskRoleDefaultPolicyEAEEDD06",
    "WorkerTaskDefinitionTaskRoleA8028804"
   ],
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerService/TaskCount/Target/Resource"
   }
  },
  "WorkerServiceTaskCountTargetSqsBacklogTargetTrackingD2F40976": {
   "Type": "AWS::ApplicationAutoScaling::ScalingPolicy",
   "Properties": {
    "PolicyName": "InfraCdkStackWorkerServiceTaskCountTargetSqsBacklogTargetTracking6392C761",
    "PolicyType": "TargetTrackingScaling",
    "ScalingTargetId": {
     "Ref": "WorkerServiceTaskCountTarget94398C8F"
    },
    "TargetTrackingScalingPolicyConfiguration": {
     "CustomizedMetricSpecification": {
      "Dimensions": [
       {
        "Name": "QueueName",
        "Value": {
         "Fn::GetAtt": [
          "ReceiptsQueue30E2F02B",
          "QueueName"
         ]
        }
       }
      ],
      "MetricName": "ApproximateNumberOfMessagesVisible",
      "Namespace": "AWS/SQS",
      "Statistic": "Average"
     },
     "TargetValue": 10
    }
   },
   "DependsOn": [
    "WorkerTaskDefinitionTaskRoleDefaultPolicyEAEEDD06",
    "WorkerTaskDefinitionTaskRoleA8028804"
   ],
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerService/TaskCount/Target/SqsBacklogTargetTracking/Resource"
   }
  },
  "BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleB6FB88EC": {
   "Type": "AWS::IAM::Role",
   "Properties": {
    "AssumeRolePolicyDocument": {
     "Statement": [
      {
       "Action": "sts:AssumeRole",
       "Effect": "Allow",
       "Principal": {
        "Service": "lambda.amazonaws.com"
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "ManagedPolicyArns": [
     {
      "Fn::Join": [
       "",
       [
        "arn:",
        {
         "Ref": "AWS::Partition"
        },
        ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
       ]
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/BucketNotificationsHandler050a0587b7544547bf325f094a3db834/Role/Resource"
   }
  },
  "BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleDefaultPolicy2CF63D36": {
   "Type": "AWS::IAM::Policy",
   "Properties": {
    "PolicyDocument": {
     "Statement": [
      {
       "Action": "s3:PutBucketNotification",
       "Effect": "Allow",
       "Resource": {
        "Fn::GetAtt": [
         "AutomatedReceiptsBucketF072455A",
         "Arn"
        ]
       }
      }
     ],
     "Version": "2012-10-17"
    },
    "PolicyName": "BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleDefaultPolicy2CF63D36",
    "Roles": [
     {
      "Ref": "BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleB6FB88EC"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/BucketNotificationsHandler050a0587b7544547bf325f094a3db834/Role/DefaultPolicy/Resource"
   }
  },
  "BucketNotificationsHandler050a0587b7544547bf325f094a3db8347ECC3691": {
   "Type": "AWS::Lambda::Function",
   "Properties": {
    "Description": "AWS CloudFormation handler for \"Custom::S3BucketNotifications\" resources (@aws-cdk/aws-s3)",
    "Code": {
     "ZipFile": "import boto3  # type: ignore\nimport json\nimport logging\nimport urllib.request\n\ns3 = boto3.client(\"s3\")\n\nEVENTBRIDGE_CONFIGURATION = 'EventBridgeConfiguration'\nCONFIGURATION_TYPES = [\"TopicConfigurations\", \"QueueConfigurations\", \"LambdaFunctionConfigurations\"]\n\ndef handler(event: dict, context):\n  response_status = \"SUCCESS\"\n  error_message = \"\"\n  try:\n    props = event[\"ResourceProperties\"]\n    notification_configuration = props[\"NotificationConfiguration\"]\n    managed = props.get('Managed', 'true').lower() == 'true'\n    skipDestinationValidation = props.get('SkipDestinationValidation', 'false').lower() == 'true'\n    stack_id = event['StackId']\n    old = event.get(\"OldResourceProperties\", {}).get(\"NotificationConfiguration\", {})\n    if managed:\n      config = handle_managed(event[\"RequestType\"], notification_configuration)\n    else:\n      config = handle_unmanaged(props[\"BucketName\"], stack_id, event[\"RequestType\"], notification_configuration, old)\n    s3.put_bucket_notification_configuration(Bucket=props[\"BucketName\"], NotificationConfiguration=config, SkipDestinationValidation=skipDestinationValidation)\n  except Exception as e:\n    logging.exception(\"Failed to put bucket notification configuration\")\n    response_status = \"FAILED\"\n    error_message = f\"Error: {str(e)}. \"\n  finally:\n    submit_response(event, context, response_status, error_message)\n\ndef handle_managed(request_type, notification_configuration):\n  if request_type == 'Delete':\n    return {}\n  return notification_configuration\n\ndef handle_unmanaged(bucket, stack_id, request_type, notification_configuration, old):\n  def get_id(n):\n    n['Id'] = ''\n    sorted_notifications = sort_filter_rules(n)\n    strToHash=json.dumps(sorted_notifications, sort_keys=True).replace('\"Name\": \"prefix\"', '\"Name\": \"Prefix\"').replace('\"Name\": \"suffix\"', '\"Name\": \"Suffix\"')\n    return f\"{stack_id}-{hash(strToHash)}\"\n  def with_id(n):\n    n['Id'] = get_id(n)\n    return n\n\n  external_notifications = {}\n  existing_notifications = s3.get_bucket_notification_configuration(Bucket=bucket)\n  for t in CONFIGURATION_TYPES:\n    if request_type == 'Update':\n        old_incoming_ids = [get_id(n) for n in old.get(t, [])]\n        external_notifications[t] = [n for n in existing_notifications.get(t, []) if not get_id(n) in old_incoming_ids]      \n    elif request_type == 'Delete':\n        external_notifications[t] = [n for n in existing_notifications.get(t, []) if not n['Id'].startswith(f\"{stack_id}-\")]\n    elif request_type == 'Create':\n        external_notifications[t] = [n for n in existing_notifications.get(t, [])]\n  if EVENTBRIDGE_CONFIGURATION in existing_notifications:\n    external_notifications[EVENTBRIDGE_CONFIGURATION] = existing_notifications[EVENTBRIDGE_CONFIGURATION]\n\n  if request_type == 'Delete':\n    return external_notifications\n\n  notifications = {}\n  for t in CONFIGURATION_TYPES:\n    external = external_notifications.get(t, [])\n    incoming = [with_id(n) for n in notification_configuration.get(t, [])]\n    notifications[t] = external + incoming\n\n  if EVENTBRIDGE_CONFIGURATION in notification_configuration:\n    notifications[EVENTBRIDGE_CONFIGURATION] = notification_configuration[EVENTBRIDGE_CONFIGURATION]\n  elif EVENTBRIDGE_CONFIGURATION in external_notifications:\n    notifications[EVENTBRIDGE_CONFIGURATION] = external_notifications[EVENTBRIDGE_CONFIGURATION]\n\n  return notifications\n\ndef submit_response(event: dict, context, response_status: str, error_message: str):\n  response_body = json.dumps(\n    {\n      \"Status\": response_status,\n      \"Reason\": f\"{error_message}See the details in CloudWatch Log Stream: {context.log_stream_name}\",\n      \"PhysicalResourceId\": event.get(\"PhysicalResourceId\") or event[\"LogicalResourceId\"],\n      \"StackId\": event[\"StackId\"],\n      \"RequestId\": event[\"RequestId\"],\n      \"LogicalResourceId\": event[\"LogicalResourceId\"],\n      \"NoEcho\": False,\n    }\n  ).encode(\"utf-8\")\n  headers = {\"content-type\": \"\", \"content-length\": str(len(response_body))}\n  try:\n    req = urllib.request.Request(url=event[\"ResponseURL\"], headers=headers, data=response_body, method=\"PUT\")\n    with urllib.request.urlopen(req) as response:\n      print(response.read().decode(\"utf-8\"))\n    print(\"Status code: \" + response.reason)\n  except Exception as e:\n      print(\"send(..) failed executing request.urlopen(..): \" + str(e))\n\ndef sort_filter_rules(json_obj):\n  if not isinstance(json_obj, dict):\n      return json_obj\n  for key, value in json_obj.items():\n      if isinstance(value, dict):\n          json_obj[key] = sort_filter_rules(value)\n      elif isinstance(value, list):\n          json_obj[key] = [sort_filter_rules(item) for item in value]\n  if \"Filter\" in json_obj and \"Key\" in json_obj[\"Filter\"] and \"FilterRules\" in json_obj[\"Filter\"][\"Key\"]:\n      filter_rules = json_obj[\"Filter\"][\"Key\"][\"FilterRules\"]\n      sorted_filter_rules = sorted(filter_rules, key=lambda x: x[\"Name\"])\n      json_obj[\"Filter\"][\"Key\"][\"FilterRules\"] = sorted_filter_rules\n  return json_obj"
    },
    "Handler": "index.handler",
    "Role": {
     "Fn::GetAtt": [
      "BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleB6FB88EC",
      "Arn"
     ]
    },
    "Runtime": "python3.13",
    "Timeout": 300
   },
   "DependsOn": [
    "BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleDefaultPolicy2CF63D36",
    "BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleB6FB88EC"
   ],
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/BucketNotificationsHandler050a0587b7544547bf325f094a3db834/Resource"
   }
  },
  "WorkerErrorMetricFilter57E8A219": {
   "Type": "AWS::Logs::MetricFilter",
   "Properties": {
    "FilterPattern": "?\"ERROR\" ?\"Error\" ?\"Unhandled\"",
    "LogGroupName": {
     "Ref": "WorkerLogGroup31FDBE4A"
    },
    "MetricTransformations": [
     {
      "DefaultValue": 0,
      "MetricName": "WorkerErrors",
      "MetricNamespace": "ReceiptProcessing",
      "MetricValue": "1"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerErrorMetricFilter/Resource"
   }
  },
  "ReceiptsQueueBacklogAlarmD9AA2EC3": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "OpsAlertsTopicF77DA89B"
     }
    ],
    "AlarmDescription": "Receipts queue backlog exceeds 50 messages for 5 minutes",
    "ComparisonOperator": "GreaterThanThreshold",
    "DatapointsToAlarm": 5,
    "Dimensions": [
     {
      "Name": "QueueName",
      "Value": {
       "Fn::GetAtt": [
        "ReceiptsQueue30E2F02B",
        "QueueName"
       ]
      }
     }
    ],
    "EvaluationPeriods": 5,
    "MetricName": "ApproximateNumberOfMessagesVisible",
    "Namespace": "AWS/SQS",
    "Period": 60,
    "Statistic": "Average",
    "Threshold": 50
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/ReceiptsQueueBacklogAlarm/Resource"
   }
  },
  "WorkerErrorAlarmAEED4951": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "OpsAlertsTopicF77DA89B"
     }
    ],
    "AlarmDescription": "Worker logs contain errors for 5 minutes",
    "ComparisonOperator": "GreaterThanThreshold",
    "DatapointsToAlarm": 1,
    "EvaluationPeriods": 1,
    "MetricName": "WorkerErrors",
    "Namespace": "ReceiptProcessing",
    "Period": 300,
    "Statistic": "Sum",
    "Threshold": 0
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/WorkerErrorAlarm/Resource"
   }
  },
  "ReceiptsBudget": {
   "Type": "AWS::Budgets::Budget",
   "Properties": {
    "Budget": {
     "BudgetLimit": {
      "Amount": 2000,
      "Unit": "INR"
     },
     "BudgetName": "ReceiptsBudget",
     "BudgetType": "COST",
     "TimeUnit": "MONTHLY"
    },
    "NotificationsWithSubscribers": [
     {
      "Notification": {
       "ComparisonOperator": "GREATER_THAN",
       "NotificationType": "ACTUAL",
       "Threshold": 100,
       "ThresholdType": "PERCENTAGE"
      },
      "Subscribers": [
       {
        "Address": {
         "Ref": "OpsAlertsTopicF77DA89B"
        },
        "SubscriptionType": "SNS"
       }
      ]
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/ReceiptsBudget"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/11SwW7jIBD9lt4J27qnPWa9arXSVs3GUa+rMSbu1Bi8MDSKEP++ApzY6cXz3hsevAFXvKoe+f0dnNxGdMNGYctDQyAGBif3NzjteDiYCQWrj7qAxrdOWJwIjU7qDc9LdkahOF8dhUbmHnn44cUgKbVmVMriWPPI3D/Hwx8vvUy9AvJ3MaxoZN1Zw2i6locDtCqbMohMioqHtynP8bar2c63CkXjW13iLGhvPMmrveiLtnXOCITL8LmRwC9N0mpJz0DyBOf5mJltiUC8j1ITa6TwFun8bI2f8gFrIeV0PNTKO5I2tS/wCWwPKYMbfsojarwk+KoYTYBa2pU2extpP1GUqWbYCFBpqrRJbbymyJTpHQ+/TX9NeMUvkiyKJ1RztjWPDGHkYW/KteW6PNLlfWCaFIp8e+DJOAEKdc/DksP283vcKqUcLIgBdd8U37L/jRCZUMZ3JyDxzsNWgR3Tmgwia33XS3I8/2sJxpxXOuOtkOwK6qN+9TR5ikybTvIP9+2zuucP3/nD3YdD3FivCUfJ96X+BzHnIJ1LAwAA"
   },
   "Metadata": {
    "aws:cdk:path": "InfraCdkStack/CDKMetadata/Default"
   }
  }
 },
 "Outputs": {
  "ReceiptsBucketNameOutput": {
   "Value": {
    "Ref": "AutomatedReceiptsBucketF072455A"
   },
   "Export": {
    "Name": "AutomatedReceiptsBucketName"
   }
  },
  "ReceiptsQueueUrlOutput": {
   "Value": {
    "Ref": "ReceiptsQueue30E2F02B"
   },
   "Export": {
    "Name": "ReceiptsQueueUrl"
   }
  },
  "ReceiptsQueueArnOutput": {
   "Value": {
    "Fn::GetAtt": [
     "ReceiptsQueue30E2F02B",
     "Arn"
    ]
   },
   "Export": {
    "Name": "ReceiptsQueueArn"
   }
  },
  "ReceiptsTableNameOutput": {
   "Value": {
    "Ref": "ReceiptsTable036B344A"
   },
   "Export": {
    "Name": "ReceiptsTableName"
   }
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}